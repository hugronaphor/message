<?php

/**
 * @file
 * Main module file.
 */
/**
 * Status constant for read messages.
 */
define('PRIVATEMSG_READ', 0);
/**
 * Status constant for unread messages.
 */
define('PRIVATEMSG_UNREAD', 1);
/**
 * Show unlimited messages in a thread.
 */
define('PRIVATEMSG_UNLIMITED', 'unlimited');

/**
 * Implements hook_permission().
 */
function umsg_permission() {
  return array(
    'administer umsg settings' => array(
      'title' => t('Administer umsg'),
      'description' => t('Perform maintenance tasks for umsg'),
    ),
    'read umsg' => array(
      'title' => t('Read own user messages'),
      'description' => t('Read own user messages'),
    ),
    'read all user messages' => array(
      'title' => t('Read all user messages'),
      'description' => t('Includes messages of other users'),
    ),
    'write umsg' => array(
      'title' => t('Write new user messages'),
      'description' => t('Write new user messages'),
    ),
    'delete umsg' => array(
      'title' => t('Delete user messages'),
      'description' => t('Delete user messages'),
    ),
//    'allow disabling umsg' => array(
//      'title' => t('Allow disabling user messages'),
//      'description' => t("Allows user to disable umsg so that they can't receive or send any user messages.")
//    ),
//    'reply only umsg' => array(
//      'title' => t('Reply to user messages'),
//      'description' => t('Allows to reply to user messages but not send new ones. Note that the write new user messages permission includes replies.')
//    ),
//    'use tokens in umsg' => array(
//      'title' => t('Use tokens in user messages'),
//      'description' => t("Allows user to use available tokens when sending user messages.")
//    ),
//    'select text format for umsg' => array(
//      'title' => t('Select text format for user messages'),
//      'description' => t('Allows to choose the text format when sending user messages. Otherwise, the default is used.'),
//    ),
  );
}

/**
 * Implements hook_menu().
 */
function umsg_menu() {

  $items['messages'] = array(
    'title' => 'Messages',
    'title callback' => 'umsg_title_callback',
    'page callback' => 'umsg_list_page',
    'page arguments' => array('list'),
    'file' => 'umsg.pages.inc',
    'access callback' => 'umsg_user_access',
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'user-menu',
  );
  $items['messages/list'] = array(
    'title' => 'Messages',
    'page callback' => 'umsg_list_page',
    'page arguments' => array('list'),
    'file' => 'umsg.pages.inc',
    'access callback' => 'umsg_user_access',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['messages/sent'] = array(
    'title' => 'Sent',
    'page callback' => 'umsg_list_page',
    'page arguments' => array('list_sent'),
    'file' => 'umsg.pages.inc',
    'access callback' => 'umsg_user_access',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['messages/trash'] = array(
    'title' => 'Trash',
    'page callback' => 'umsg_list_page',
    'page arguments' => array('list_trash'),
    'file' => 'umsg.pages.inc',
    'access callback' => 'umsg_user_access',
    'type' => MENU_NORMAL_ITEM,
    'weight' => -10,
  );
//  $items['messages/view/%privatemsg_thread'] = array(
//    // Set the third argument to TRUE so that we can show access denied instead
//    // of not found.
//    'load arguments'   => array(NULL, NULL, TRUE),
//    'title'            => 'Read message',
//    'page callback'    => 'privatemsg_view',
//    'page arguments'   => array(2),
//    'file'             => 'umsg.pages.inc',
//    'access callback'  => 'privatemsg_view_access',
//    'access arguments' => array(2),
//    'type'             => MENU_LOCAL_TASK,
//    'weight'           => -5,
//    'menu_name'        => 'user-menu',
//  );
//  $items['messages/delete/%privatemsg_thread/%privatemsg_message'] = array(
//    'title'            => 'Delete message',
//    'page callback'    => 'drupal_get_form',
//    'page arguments'   => array('privatemsg_delete', 2, 3),
//    'file'             => 'umsg.pages.inc',
//    'access callback'  => 'privatemsg_user_access',
//    'access arguments' => array('delete privatemsg'),
//    'type'             => MENU_CALLBACK,
//    'weight'           => -10,
//    'menu_name'        => 'user-menu',
//  );
  $items['messages/new'] = array(
    'title' => 'Write new message',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('umsg_new', 2, 3, NULL),
    'file' => 'umsg.pages.inc',
    'access callback' => 'umsg_user_access',
    'access arguments' => array('write privatemsg'),
    'type' => MENU_LOCAL_ACTION,
    'weight' => -3,
    'menu_name' => 'user-menu',
  );
  // Auto-completes available user names & removes duplicates.
  $items['messages/autocomplete'] = array(
    'page callback' => 'umsg_autocomplete',
    'file' => 'umsg.pages.inc',
    'access callback' => 'umsg_user_access',
    'access arguments' => array('write umsg'),
    'type' => MENU_CALLBACK,
  );
  // Admin pages.
  $items['admin/config/messaging/umsg'] = array(
    'title' => 'User message settings',
    'description' => 'Configure user messaging settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('umsg_admin_settings'),
    'file' => 'umsg.admin.inc',
    'access arguments' => array('administer umsg settings'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/config/messaging/umsg/settings'] = array(
    'title' => 'User message settings',
    'description' => 'Configure user messaging settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('umsg_admin_settings'),
    'file' => 'umsg.admin.inc',
    'access arguments' => array('administer umsg settings'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  return $items;
}

function umsg_preprocess_html(&$vars) {
  
}

/**
 * Wrapper for user_access.
 *
 * Never allows anonymous user access.
 *
 * @param $permission
 *   Permission string, defaults to read privatemsg
 *
 * @return
 *   TRUE if user has access, FALSE if not
 *
 * @ingroup api
 */
function umsg_user_access($permission = 'read umsg', $account = NULL) {
  if ($account === NULL) {
    global $user;
    $account = $user;
  }

  // Disallow anonymous access, regardless of permissions
  if (!$account->uid) {
    return FALSE;
  }

  if (!user_access($permission, $account)) {
    return FALSE;
  }
  return TRUE;
}

function umsg_title_callback($scope = NULL) {
  
  $count = umsg_unread_count();

  if ($count > 0) {
    if ($scope == 'nav') {
      return t('Inbox %count', array('%count' => $count));
    }
    else {
      return t('Inbox (@count)', array('@count' => $count));
    }
  }
  return t('Inbox');
}

/**
 * Return number of unread messages for an account.
 *
 * @param $account
 *   Specify the user for which the unread count should be loaded.
 *
 * @ingroup api
 */
function umsg_unread_count($scope = 'index') {
  global $user;
  $account = $user;

  $counts = &drupal_static(__FUNCTION__ . $account->uid . $scope);

  if (!isset($counts)) {
    // Count Inbox/Archivet unreaded threads.
    $umsg = new umsgController();
    $counts = $umsg->countUnread($account, $scope);
  }
  
  return $counts;
}

/**
 * Formats all rows (#options) in the message tableselect thread list.
 *
 * Uses @link theming theme patterns @endlink to theme single fields.
 *
 * @param $thread
 *   Array with the row data returned by the database.
 * @return
 *   Row definition for use with theme('table')
 */
function _umsg_list_thread($tableselect) {
  foreach ($tableselect['#options'] as $id => $thread) {
    $row = array();
    if (!empty($thread['is_new'])) {
      // Set the css class in the tr tag.
      $row['#attributes']['class'][] = 'umsg-unread';
    }

    foreach ($thread as $key => $data) {
      //dsm('umsg_list_field__' . $key);
      // First, try to load a specific theme for that field, if not present, use the default.
      if ($return = theme('umsg_list_field__' . $key, array('thread' => $thread))) {
        $row[$key] = $return;
      }
    }

    $row[$key] = $return;

    $tableselect['#options'][$id] = $row;

    ///dsm($tableselect);
  }
  return $tableselect;
}

function umsg_theme() {
  $templates = array(
//    'umsg_view'    => array(
//      'variables'        => array('message' => NULL),
//      'template'         => variable_get('umsg_message_view_template', 'umsg-view'), // 'umsg',
//    ),
//    'umsg_from'    => array(
//      'variables'        => array('author' => NULL),
//      'template'         => 'umsg-from',
//    ),
//    'umsg_recipients' => array(
//      'variables'        => array('message' => NULL),
//      'template'         => 'umsg-recipients',
//    ),
//    'umsg_between' => array(
//      'variables'        => array('recipients' => NULL),
//      'template'         => 'umsg-between',
//    ),
    // Define pattern for header/field templates. The theme system will register all
    // theme functions that start with the defined pattern.
    'umsg_list_header' => array(
      'file' => 'umsg.theme.inc',
      'path' => drupal_get_path('module', 'umsg'),
      'pattern' => 'umsg_list_header__',
      'variables' => array(),
    ),
    'umsg_list_field' => array(
      'file' => 'umsg.theme.inc',
      'path' => drupal_get_path('module', 'umsg'),
      'pattern' => 'umsg_list_field__',
      'variables' => array('thread' => array()),
    ),
//    'umsg_new_block'  => array(
//      'file'                  => 'umsg.theme.inc',
//      'path'                  => drupal_get_path('module', 'umsg'),
//      'variables'             => array('count'),
//    ),
//    'umsg_username'  => array(
//      'file'                  => 'umsg.theme.inc',
//      'path'                  => drupal_get_path('module', 'umsg'),
//      'variables'             => array('recipient' => NULL, 'options' => array()),
//    ),
  );
  // Include the theme file to load the theme suggestions.
  module_load_include('inc', 'umsg', 'umsg.theme');
  $templates += drupal_find_theme_functions($templates, array('theme'));
  return $templates;
}

/**
 * Formats a timestamp according to the defines rules.
 *
 * Examples/Rules:
 *
 * Current hour: 25 min ago
 * Current day (but not within the hour): 10:30 am
 * Current year (but not on the same day): Nov 25
 * Prior years (not the current year): 11/25/08
 *
 * @param $timestamp
 *   UNIX Timestamp.
 *
 * @return
 *   The formatted date.
 */
function umsg_format_date($timestamp) {
  if ($timestamp > ((int) (REQUEST_TIME / 3600)) * 3600) {
    return t('@interval ago', array('@interval' => format_interval(abs(REQUEST_TIME - $timestamp), 1)));
  }
  if ($timestamp > ((int) (REQUEST_TIME / 86400)) * 86400) {
    return format_date($timestamp, 'umsg_current_day');
  }
  if ($timestamp > mktime(0, 0, 0, 1, 0, date('Y'))) {
    return format_date($timestamp, 'umsg_current_year');
  }
  return format_date($timestamp, 'umsg_years');
}

/**
 * Implements hook_block_info().
 */
function umsg_block_info() {
  $blocks['umsg_msg_navigation'] = array(
    'info' => t('Main Message navigation'),
    'cache' => DRUPAL_CACHE_PER_USER,
  );

  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function umsg_block_configure($delta) {
  
}

/**
 * Implements hook_block_save().
 */
function umsg_block_save($delta, $edit = array()) {
  
}

/**
 * Implements hook_block_view().
 */
function umsg_block_view($delta) {
  $block = array();
  switch ($delta) {
    case 'umsg_msg_navigation':
      //$block['subject'] = t('Din aceeasi categorie');
      $block['content'] = _umsg_get_main_navigation();
      break;
  }
  return $block;
}

function _umsg_get_main_navigation() {
  $block = array();

  $links = array();
  if (umsg_user_access('write umsg')) {
    $links[] = l(t('Compose message'), 'messages/new');
  }
  if (umsg_user_access('read umsg') || umsg_user_access('read all user messages')) {
    $links[] = l(umsg_title_callback('nav'), 'messages/list', array('html' => TRUE));
    $links[] = l(t('Sent'), 'messages/sent');
    $links[] = l(t('Trash %trash_count', array('%trash_count' => umsg_unread_count('trash'))), 'messages/trash', array('html' => TRUE));
  }

  if (count($links)) {
    $block = array(
      //'subject' => t('Private messages'),
      'content' => theme('item_list', array('items' => $links)),
    );
  }
  return $block;
}

/**
 * Returns a table header definition based on the submitted keys.
 *
 * Uses @link theming theme patterns @endlink to theme single headers.
 *
 * @param $has_posts
 *   TRUE when there is at least one row. Decides if the select all checkbox should be displayed.
 * @param $keys
 *   Array with the keys which are present in the query/should be displayed.
 * @return
 *   Array with header definitions for tablesort_sql and theme('table').
 */
function _umsg_list_headers($keys) {

  // theme() doesn't include the theme file for patterns, we need to do it manually.
  include_once drupal_get_path('module', 'umsg') . '/umsg.theme.inc';

  $header = array();
  foreach ($keys as $key) {
    // First, try to load a specific theme for that header, if not present, use the default.
    if ($return = theme('umsg_list_header__' . $key)) {
      // The default theme returns nothing, only store the value if we have something.
      $header[$key] = $return;
    }
  }
  // uasort($header, 'element_sort');
  // Remove weight column or it will show up in the markup.
  foreach ($header as $key => $element) {
    if (isset($header[$key]['#weight'])) {
      unset($header[$key]['#weight']);
    }
  }
  return $header;
}

/**
 * Delete or restore one or multiple threads.
 *
 * @param $threads
 *   Array with thread id's or a single thread id.
 * @param $delete
 *   Indicates if the threads should be deleted or restored. 1 => delete, 0 => restore.
 * @param $account
 *   User account for which the delete action should be carried out - Set to NULL to delete for all users.
 */
function umsg_thread_change_delete($threads, $delete, $account = NULL) {
  if (!is_array($threads)) {
    $threads = array($threads);
  }
  if (empty($account)) {
    global $user;
    $account = clone $user;
  }

  drupal_set_message('Test delete!');
  
  return;
  
  
  // Load all messages of those threads including the deleted.
  $query = _privatemsg_assemble_query('messages', $threads, $account, TRUE);

  // Delete each message. We need to do that to trigger the delete hook.
  foreach ($query->execute() as $row) {
    privatemsg_message_change_delete($row->mid, $delete, $account);
  }

  if ($delete) {
    drupal_set_message(format_plural(count($threads), 'Deleted 1 thread.', 'Deleted @count threads.'));
  }
  else {
    drupal_set_message(format_plural(count($threads), 'Restored 1 thread.', 'Restored @count threads.'));
  }
}